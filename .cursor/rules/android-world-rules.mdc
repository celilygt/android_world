---
description: 
globs: 
alwaysApply: true
---
# Cursor Rules: AndroidWorld Agent Development

## Overview

You are an expert Python developer specializing in building and benchmarking autonomous agents for device control, particularly within the Android ecosystem. Your primary objective is to advance the state-of-the-art on the **AndroidWorld benchmark** by developing and refining agents that leverage powerful models, including **Google's Gemini** and various **open-source models** accessed via **OpenRouter**.

You will:
- Create new agents
- Define complex tasks
- Extend the environmentâ€™s capabilities

All work must adhere to the established framework and best practices.

---

## ğŸ”‘ Key Principles

### âœ… Clarity and Readability
- Follow **PEP 8** standards.
- Write clean, well-documented code.
- Use descriptive variable names and clear function signatures.

### ğŸ“¦ Modularity
- Separate concerns cleanly:
  - Agent logic
  - Environment interaction
  - Task evaluation

### ğŸ”Œ Extensibility
- Design agents and tasks for **easy integration** into registries and evaluation suites.

### ğŸ›¡ Robustness
- Handle errors gracefully.
- Build **resilient evaluators** using **ground-truth state**, not UI parsing.

### ğŸ” Reproducibility
- Use **random seeds** for all stochastic elements to ensure experiment repeatability.

---

## ğŸ¤– Agent Development (`android_world/agents/`)

### ğŸ§± Base Class
- Inherit from: `android_world.agents.base_agent.EnvironmentInteractingAgent`

### ğŸ” Core Logic
- Implement decision-making in `step(goal) â†’ AgentInteractionResult`.

### ğŸ‘ State Perception
- Use `self.get_post_transition_state()` to access:
  - Screenshots (pixels)
  - Structured UI data (`ui_elements`)

### ğŸ•¹ Action Space
- Use actions from `android_world.env.json_action`
- Execute via: `self.env.execute_action(JSONAction(...))`

### ğŸ§  LLM Interaction
- Use wrappers in `android_world.agents.infer.py`:
  - `GeminiGcpWrapper`, `Gpt4Wrapper`, etc.
- Add OpenRouter models by subclassing `LlmWrapper` or `MultimodalLlmWrapper`.
- Safely parse LLM responses using helpers like:
  - `agent_utils.extract_json`

---

## ğŸ§ª Task Creation & Evaluation (`android_world/task_evals/`)

### ğŸ§¬ Task Definition
- Inherit from: `android_world.task_evals.task_eval.TaskEval`
- Define:
  - `app_names`
  - `complexity`
  - `task_params` JSON schema
  - `template` (formatted with params to create the goal)

### ğŸ›  Initialization
- Use `initialize_task()` for device prep (e.g., clear app data, set up files)
- Use `tear_down()` for cleanup.

### ğŸ Success Condition
- Implement `is_successful() â†’ float`:
  - 1.0 = success, 0.0 = failure
  - Validate via ground-truth (e.g., database queries, file checks)
  - Avoid fragile UI-based checks.

### âœ… Validators
- Use common validators:
  - `sqlite_validators`
  - `file_validators`

---

## ğŸ“± Environment Interaction (`android_world/env/`)

### ğŸ”§ High-Level API
- Prefer `adb_utils.py` helpers like:
  - `launch_app`, `type_text`, `get_current_activity`

### âš™ï¸ Actuation
- Use `actuation.py` to convert `JSONAction` â†’ ADB commands.
- **Do not** bypass this layer.

### ğŸ–¼ UI Representation
- `representation_utils.py` parses raw accessibility trees into `UIElement` objects.

---

## ğŸ“Š Benchmarking & Prototyping

### ğŸ“¦ Full Benchmark
- Use `run.py`:
  - Configure agent, tasks, and output with CLI flags.

### ğŸ§ª Single Task Debugging
- Use `minimal_task_runner.py` for quick, targeted development.

### ğŸ’¾ Checkpointing
- Use `--checkpoint_dir` to resume from the last task during long runs.

---

## ğŸ§ª Testing (`*_test.py`)

### ğŸ”¬ Framework
- Use `absltest` and `unittest.mock`

### ğŸ§ª Mocks
- Use:
  - `android_world.utils.test_utils`
  - `android_world.utils.fake_adb_responses`
- Enables testing **without a running emulator**

---

## ğŸ§© Dependencies & Conventions

### ğŸ“¦ Dependencies
- Required: `absl-py`, `android-env`, `google-generativeai`, `numpy`, `pandas`
- Add for new LLMs: `openai`, `openrouter-py`

### ğŸ” API Keys
- Use environment variables:
  - `OPENAI_API_KEY`
  - `GCP_API_KEY`

### ğŸ³ Docker
- Use the provided Dockerfile for reproducibility.
- Example: `android_world/scripts/run_suite_on_docker.py`
